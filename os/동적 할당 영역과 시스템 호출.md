
# 프로스의 동적 할당 영역

프로세스는 코드 영역, 데이터 영역, 스택 영역으로 이루어져 있는데 좀 더 정확히 말하면 힙 영역도 있다.

![](https://open4tech.com/wp-content/uploads/2017/03/Memory_model.jpg)

- 정적 할당 영역 
	- 코드 영역
	- 데이터 영역

코드 영역은 프로그램의 본체가 있는 곳이고, 데이터 영역은 프로그램이 사용하려고 정의한 변수와 데이터가 있는 곳이다. 포인터를 제외한 일반적인 변수는 선언할 때 그 크기가 결정된다. 따라서 코드 영역과 데이터 영역은 프로세스가 실행되기 직전에 위치와 크기가 결정되고 실행되는 동안 변하지 않으므로 정적 할당 영역이라 부른다.

- 동적 할당 영역 
	- 힙 영역
	- 스택 영역
	- free space

스택 영역과 힙 영역은 프로세스가 실행되는 동안 만들어지는 영역으로 그 크기가 늘기도 하고 줄어들기도 하는 동적 할당 영역이다.

### 스택 영역

함수 호출 시 두 가지 작업을 구현하는데 스택이 사용된다.

1) 호출한 함수가 종료되면 함수를 호출하기 전 코드로 되돌아와야 하는데 되돌아올 메모리의 주소를 스택에 저장한다. 여기서 함수 호출과 복귀 시에 스택이 사용된다.
2) 스택은 변수 사용 범위에 영향을 미치는 영역을 구현할 때 사용된다. 변수는 전역변수와 지역 변수로 나뉘는데, 전역 변수는 프로그램 내에 있는 모든 함수에서 사용할 수 있고 지역 변수는 특정 함수에서만 사용 할 수 있다. 지역 변수는 함수가 호출될 때만 사용되다가 함수가 종료되면 사용한 공간을 반환해야 하는데 지역 변수를 저장 할 때 스택이 사용된다.

스택은 First In Last Out 이기에 스택에 데이터를 삽입하는 것을 push, 꺼내는 것을 pop이라 한다.

따라서 함수가 여러개일때 스택영역에 순차적으로 쌓이고 마지막으로 들어온 것들이 pop 되면서 위로 올라가 함수가 반환되면서 사라진다.

스택은 프로세스를 작동하기 위해 커널이 유지하는 자료구조다. 프로세스와 스레드를 구분했는데 스택을 더 정확하게 표현하면 스레드가 작동하는 동안 추가되거나 삭제되는 동적 할당 영역으로 정의 할 수 있다.

일반적으로 프로세스가 사용하는 함수는 컴파일 할 때 결정 된다. 스택 영역은 스레드가 진행됨에 따라 커지기도 하고 작아지기도 한다. 즉 스택은 동적 영역이다.

#### 힙 영역

힙은 동적으로 할당되는 변수 영역이다. 대부분의 데이터는 데이터 영역에 할당되고 그 크기가 정해 진다. 그러나 일부 데이터는 프로그램이 실행되는 동안 할당되는데 대표적인 경우가 malloc() 함수다.

C에서 malloc 함수를 사용하면 힙 영역에 공간을 배정한다. 미리 선언해 사용하는 것과는 다르다. 필요 없으면 free()함수로 메모리 영역을 반환한다.

중급 수준 이상의 프로그래머라면 문제 해결과 동시에 메모리 관리에도 신경을 써야 한다. 같은 프로그램이라도 메모리 공간을 많이 사용하는 프로그램은 공간을 적게 사용하는 프로그램 보다 느리다. 무작정 큰 공간을 배열로 확보하면 메모리가 낭비되고 시스템이 느려진다.

# exit()와 wait() 시스템 호출

#### exit()

exit 또는 return을 사용하는 이유는 자식 프로세스가 끝났음을 부모 프로세스에게 알려주기 위함이다. 부모-자식 관계를 만드는 이유는 사용하던 자원을 회수하기가 용이하기 때문이다. exit 함수를 선엄함으로써 부모 프로세스는 자식 프로세스가 사용하던 자원을 빨리 거둬 갈 수 있다. exit 함수는 전달하는 인자를 확인하여 자식 프로세스가 어떤 상태로 종료되었지를 알려주는데 인자가 0이면 정상, -1이면 비정상 종료다.

#### wait()

자식의 자원을 정리해야할 부모 프로세스가 먼저 종료되면 자식 프로세스의 exit 함수는 돌아갈 곳이 없으므로 이 자식 프로세스는 **고아 프로세스**가 된다. 물론 반환되지 못한 자원은 나중에 OS의 자원 회수로 처리되지만 고아 프로세스가 많이 발생하면 시스템의 자원이 낭비 된다.

OS는 부모 프로세스가 먼저 종료됨으로써 고아 프로세스가 생기는 것을 방지하기 위해 wait 함수를 사용한다. wait 함수는 자식 프로세스가 끝나기를 기다렸다가 자식 프로세스가 종료되면 다음 문장을 실행한다. 자식 프로세스의 eixt(0)이 실행되어 프로세스가 끝나면 부모 프로세스는 wait 함수 다음 코드가 실행되어 부모 프로세스의 프로세스 구분자가 출력된다. 이러한 특징 때문에 wait 함수는 부모 , 자식 프로세스 간 동기화에도 사용한다. 이때 맨 앞에서 작동하는 프로세스를 전면 프로세스(foreground process), 뒤에서 작동하는 프로세스를 후면 프로세스(background process) 라고 한다.



